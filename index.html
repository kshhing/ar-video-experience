<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AR Poster Video</title>
  <!-- MindAR + Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-three.prod.js"></script>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    body { font-family: Arial, sans-serif; }
    #ar-container { width:100%; height:100%; position:absolute; top:0; left:0; }
    #start-ar {
      position:absolute; top:50%; left:50%; transform: translate(-50%,-50%);
      padding:20px 40px; font-size:28px; background:#3498db; color:#fff;
      border:none; border-radius:10px; cursor:pointer; z-index:1000;
    }
    #scanning-msg, #found-msg, #unmute-btn, #error-msg {
      position:fixed; left:50%; transform:translateX(-50%); text-align:center;
      padding:15px 25px; font-size:24px; color:#fff; border-radius:8px;
      display:none; z-index:1000;
    }
    #scanning-msg { bottom:40px; background:rgba(0,0,0,0.7); }
    #found-msg  { top:40px; background:rgba(40,167,69,0.9); }
    #unmute-btn { bottom:100px; background:#4CAF50; }
    #error-msg  { top:50%; transform:translate(-50%,-50%); background:rgba(220,53,69,0.9); }
  </style>
</head>
<body>
  <div id="ar-container"></div>
  <button id="start-ar">Tap to Start AR</button>
  <div id="scanning-msg">Point your camera at the poster</div>
  <div id="found-msg">Video is playing</div>
  <button id="unmute-btn">Tap for sound</button>
  <div id="error-msg"></div>

  <script>
    const startButton = document.getElementById("start-ar");
    const scanningMsg = document.getElementById("scanning-msg");
    const foundMsg = document.getElementById("found-msg");
    const unmuteBtn = document.getElementById("unmute-btn");
    const errorMsg = document.getElementById("error-msg");

    function showError(msg) {
      errorMsg.innerHTML = `<p>${msg}</p><button onclick="location.reload()" style="margin-top:15px;padding:10px 20px;font-size:20px;border:none;border-radius:8px;background:#007bff;color:#fff;">Retry</button>`;
      errorMsg.style.display = 'block';
    }

    function checkLibraries() {
      return (typeof window.MINDAR !== 'undefined' || typeof window.MindARThree !== 'undefined');
    }

    startButton.addEventListener("click", async () => {
      startButton.style.display = 'none';

      if (!checkLibraries()) {
        showError("AR libraries not loaded. Please check your internet connection.");
        return;
      }

      const mindarThree = new window.MindARThree({
        container: document.querySelector("#ar-container"),
        imageTargetSrc: "targets.mind",
        uiScanning: false,
        uiLoading: false
      });

      const { renderer, scene, camera } = mindarThree;

      const video = document.createElement("video");
      video.src = "ar-video-experience/your-video.mp4";
      video.muted = true;
      video.playsInline = true;
      video.loop = true;
      video.preload = "auto";
      video.load();

      video.onerror = () => {
        showError("Error loading video. Ensure 'ar-video-experience/your-video.mp4' is uploaded to your GitHub repo.");
      };

      const texture = new THREE.VideoTexture(video);
      const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
      const geometry = new THREE.PlaneGeometry(1, 1);
      const plane = new THREE.Mesh(geometry, material);

      const anchor = mindarThree.addAnchor(0);
      anchor.group.add(plane);

      video.addEventListener('loadedmetadata', () => {
        const aspect = video.videoHeight / video.videoWidth;
        plane.geometry = new THREE.PlaneGeometry(1, aspect);
      });

      anchor.onTargetFound = () => {
        scanningMsg.style.display = "none";
        foundMsg.style.display = "block";
        video.play().then(() => {
          unmuteBtn.style.display = 'block';
        }).catch(() => {
          video.muted = true;
          video.play().then(() => {
            unmuteBtn.style.display = 'block';
          }).catch(() => {
            showError("Video couldn't play. Try again.");
          });
        });
        setTimeout(() => foundMsg.style.display = "none", 4000);
      };

      anchor.onTargetLost = () => {
        scanningMsg.style.display = "block";
        foundMsg.style.display = "none";
        unmuteBtn.style.display = 'none';
        video.pause();
      };

      unmuteBtn.onclick = () => {
        video.muted = false;
        unmuteBtn.style.display = 'none';
      };

      try {
        await mindarThree.start();
        scanningMsg.style.display = "block";
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
      } catch (e) {
        showError("Failed to start AR: " + e.message);
      }

      window.addEventListener("resize", () => {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      });
    });
  </script>
</body>
</html>
